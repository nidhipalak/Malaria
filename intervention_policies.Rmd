---
title: "Intervention Policies"
author: "Murrel Pereira"
date: "11/20/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(malariaAtlas)
library(leaflet)
library(ggridges)
library(readxl)
library(plotly)
library(patchwork)

knitr::opts_chunk$set(
  fig.width=6,
  fig.asp=.9,
  out.width ="60%"
)

theme_set(theme_minimal() +theme(legend.position = "bottom"))

options(
  ggplot2.continuous.color = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete=scale_fill_viridis_d
```

```{r, include=FALSE}

countries = c("Nigeria", "Democratic Republic of the Congo", "Uganda","Mozambique", "CÃ´te d'Ivoire", "Niger", "Burkina Faso", "Mali", "Angola", "United Republic of Tanzania", "India", "Ghana", "Cameroon", "Rwanda", "Benin", "Malawi", "Kenya", "Guinea", "Algeria", "Argentina", "Iran", "Malaysia","Timor-Leste", "China", "El Salvador", "Cabo Verde")

```

### Drug treatment policies in 2018
```{r, include=FALSE}
policy_pf_df = 
  read_excel(
    "./data/antimalarial_drug_policy.xlsx", range = "A4:E105") %>% 
  janitor::clean_names() %>% 
  rename(
    country = who_region_country_area
  ) %>% 
  filter(
    country %in% countries
  ) %>% 
  pivot_longer(
    uncomplicated_unconfirmed:prevention_during_pregnancy,
    names_to = "case_type",
    values_to = "treatment_policy"
  ) %>% 
  mutate(
    al = str_detect(treatment_policy, "AL"),
    as = str_detect(treatment_policy, "AS"),
    qn = str_detect(treatment_policy, "QN"),
    sp_ipt = str_detect(treatment_policy, "SP\\(IPT"),
    aq = str_detect(treatment_policy, "AQ"),
    am = str_detect(treatment_policy, "AM"),
    cq = str_detect(treatment_policy, "CQ"),
    pq = str_detect(treatment_policy, "PQ"),
  ) %>% 
  select(-treatment_policy)

policy_pf_df = 
policy_pf_df %>% 
  pivot_longer(
    al:pq,
    names_to = "treatment",
    values_to = "treatment_policy"
  ) %>% 
  nest(treatment_policies_df = c(case_type, treatment, treatment_policy))

```

### Estimated cases and deaths
```{r, include=FALSE}
estimate_cases_deaths_df = 
  read_excel(
    "./data/population_at_risk_estimated_cases_deaths.xls", sheet = "apendix_f_data", range = "A2:J1037") %>% 
  janitor::clean_names() %>% 
  filter(country %in% countries) %>% 
  select(-cases_lower, -cases_upper, -deaths_lower, -deaths_upper) %>% 
  rename(
    cases = cases_point,
    deaths = deaths_point
  ) %>% 
  mutate(
    prevalence = cases / population_at_risk,
    mortality = deaths / population_at_risk
  )
```

### Percentage of nets/act treatments (2016 - 2018)
```{r, include=FALSE}
commodities_df =
  read_excel(
    "./data/commodities_distribution.xlsx", range = "A4:H297") %>% 
  janitor::clean_names() %>% 
  rename(country = who_region_country_area) %>% 
  fill(country, .direction = "down") %>% 
  filter(country %in% countries) 
```

Commodities data is short and is not normalized relative to population. Use the household stats data instead

### Combine commodities and cases/deaths df
```{r}
est_cases_commodities_df =
  left_join(estimate_cases_deaths_df, commodities_df, by = c("country","year")) 
```

What is the population malaria prevelance and mortality?
```{r}
ggplotly(ggplot(estimate_cases_deaths_df, aes(x = year, y = prevalence, color = country)) + geom_point() + geom_line())

ggplotly(ggplot(estimate_cases_deaths_df, aes(x = year, y = mortality, color = country)) + geom_point() + geom_line() )
```

### Clean up data from STAT compiler household statistics (2015 - 2018)
```{r}
household_stat_df =
  read_excel(
    "./data/household_survey_STAT.xls", range = "A4:T44", col_names = c("country", "source", "% of households with at least one ITN", "% of households with at least one ITN for every two persons who stayed in the household the previous night", "% of households with IRS in last 12 months", "% of households with at least one ITN and/or IRS in the past 12 months", "% of householdswith at least one ITN for every two persons and/or IRS in the past 12 months", "% of population with access to an ITN", "% of population who slept under an ITN last night", "% of ITNs that were used last night", "% of pregnant women who slept under an ITN", "% of pregnant women who took 3+ doses of IPTp", "% of children <5 years who slept under an ITN", "% of children <5 years with moderate or severe anaemia", "% of children <5 yearswith a positive RDT", "% of children <5 years with a positive microscopy blood smear", "% of children <5 years with fever in last 2 weeksfor whom advice or treatment was sought", "% of children <5 years with fever in last 2 weekswho had blood taken from a finger or heel for testing", "% of children <5 years with fever in last 2 weeks who took antimalarial drugs", "% of children <5 years with fever in last 2 weeks who took an ACT among those who received any antimalarial")) %>% 
  janitor::clean_names() %>% 
  filter(
    country %in% countries
  ) %>% 
  pivot_longer(
    percent_of_households_with_at_least_one_itn:percent_of_children_5_years_with_fever_in_last_2_weeks_who_took_an_act_among_those_who_received_any_antimalarial,
    names_to = "preventative_measure",
    values_to = "percentage"
  ) %>% 
  drop_na(percentage) %>% 
  mutate(
    percentage = as.numeric(percentage),
    year = substr(source, 1, 4),
   year = as.integer(year),
   year_end = substr(source, 6, 7),
   year_end = case_when(
     str_detect(year_end, "[MDA][IH]") == TRUE ~ NA_character_,
     str_detect(year_end, "[MDA][IH]") == FALSE ~ year_end
  ),
  year_end = str_c("20", year_end),
  year_end = as.integer(year_end)
  ) %>% 
  select(-source)
```

```{r}
itn_df = 
household_stat_df %>% 
  filter(preventative_measure %in% c("percent_of_households_with_at_least_one_itn", 
                                     "percent_of_pregnant_women_who_slept_under_an_itn",
                                    "percent_of_children_5_years_who_slept_under_an_itn")) %>% 
  pivot_wider(
    names_from = preventative_measure,
    values_from = percentage
  ) %>% 
  right_join(estimate_cases_deaths_df, by = c("country", "year")) %>% 
  drop_na(percent_of_households_with_at_least_one_itn) %>% 
  mutate(
    country = as.factor(country),
    country = fct_reorder(country, prevalence)
  ) 
```

## Children under an ITN
```{r}
children_itn = 
itn_df %>% 
  ggplot(aes(x = prevalence, color = country)) +
  geom_point(aes(y = percent_of_children_5_years_who_slept_under_an_itn)) + 
  labs(title = "ITN Usage: Children <5 Years Age",x = "Prevalence", y= "% ITN Usage"
  ) + theme(legend.position = "none")
```

## Pregnant women under an ITN
```{r}
preg_women_itn = 
itn_df %>% 
  ggplot(aes(x = prevalence, color = country)) +
  geom_point(aes(y = percent_of_pregnant_women_who_slept_under_an_itn)) + 
  labs(title = "ITN Usage: Pregnant Women",x = "Prevalence", y= "% ITN Usage"
  ) + theme(legend.position = "none")
```

## Households under an ITN
```{r}
household_itn = 
itn_df %>% 
  ggplot(aes(x = prevalence, color = country)) +
  geom_point(aes(y = percent_of_households_with_at_least_one_itn)) + 
  labs(title = "ITN Usage: Households",x = "Prevalence", y= "% ITN Usage"
  ) + theme(legend.position = "none")
```

```{r}
household_itn / preg_women_itn / children_itn
```

## Children under an ITN
```{r}
children_itn_mort = 
itn_df %>% 
  ggplot(aes(x = mortality, color = country)) +
  geom_point(aes(y = percent_of_children_5_years_who_slept_under_an_itn)) + 
  labs(title = "ITN Usage: Children <5 Years Age",x = "Mortality", y= "% ITN Usage"
  ) + theme(legend.position = "none")
```

## Pregnant women under an ITN
```{r}
preg_women_itn_mort = 
itn_df %>% 
  ggplot(aes(x = mortality, color = country)) +
  geom_point(aes(y = percent_of_pregnant_women_who_slept_under_an_itn)) + 
  labs(title = "ITN Usage: Pregnant Women",x = "Mortality", y= "% ITN Usage"
  ) + theme(legend.position = "none")
```

## Households under an ITN
```{r}
household_itn_mort = 
itn_df %>% 
  ggplot(aes(x = mortality, color = country)) +
  geom_point(aes(y = percent_of_households_with_at_least_one_itn)) + 
  labs(title = "ITN Usage: Households",x = "Mortality", y= "% ITN Usage"
  ) + theme(legend.position = "none")
```

```{r}
household_itn_mort / preg_women_itn_mort / children_itn_mort
```
